<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-active { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    .tab-inactive { background: #f1f5f9; color: #64748b; }
    .tab-inactive:hover { background: #e2e8f0; color: #475569; }
    
    /* Table Styling */
    .table-container { overflow-x: auto; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
    thead th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
    
    /* Input removal arrows */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="h-full bg-slate-50 text-slate-800">

  <div id="app" class="h-full flex flex-col">
    <!-- Header -->
    <header class="bg-white border-b border-slate-200 shadow-sm z-30 flex-none">
      <div class="max-w-7xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg bg-sky-600 text-white flex items-center justify-center text-xl shadow-lg">üìä</div>
          <div>
            <h1 class="font-bold text-lg leading-tight">‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
            <p class="text-xs text-slate-500">School Management System</p>
          </div>
        </div>
        <div class="flex items-center gap-3">
          <span id="status-badge" class="px-2 py-1 rounded-full bg-slate-100 text-xs font-medium text-slate-500 flex items-center gap-1">
            <span id="status-dot" class="w-2 h-2 rounded-full bg-slate-400"></span>
            <span id="status-text">Connecting...</span>
          </span>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 overflow-auto p-4 md:p-6">
      <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Navigation Tabs -->
        <div class="flex gap-2 p-1 bg-white rounded-xl shadow-sm border border-slate-100 w-fit">
          <button onclick="switchTab('setup')" id="tab-setup" class="tab-active px-6 py-2 rounded-lg text-sm font-semibold transition-all">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          <button onclick="switchTab('score')" id="tab-score" class="tab-inactive px-6 py-2 rounded-lg text-sm font-semibold transition-all">üìù ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
          <button onclick="switchTab('attendance')" id="tab-attendance" class="tab-inactive px-6 py-2 rounded-lg text-sm font-semibold transition-all">üìÖ ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
        </div>

        <!-- ==================== 1. SETUP SECTION ==================== -->
        <section id="setup-section" class="space-y-6 animate-fade">
          
          <!-- Score Config (‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡πà‡∏≠‡∏ô) -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
              <span class="bg-sky-100 text-sky-600 w-8 h-8 rounded-full flex items-center justify-center text-sm">1</span>
              ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô)
            </h2>
            <div class="flex flex-wrap gap-2 mb-4 items-end bg-slate-50 p-4 rounded-lg">
               <div class="flex-1 min-w-[200px]">
                 <label class="text-xs font-semibold text-slate-500 ml-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ)</label>
                 <input type="text" id="config-name" class="w-full mt-1 border border-slate-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-sky-500 outline-none">
               </div>
               <div class="w-24">
                 <label class="text-xs font-semibold text-slate-500 ml-1">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°</label>
                 <input type="number" id="config-max" placeholder="1-100" class="w-full mt-1 border border-slate-300 rounded-lg px-3 py-2 text-sm text-center outline-none">
               </div>
               <div class="w-24">
                 <label class="text-xs font-semibold text-slate-500 ml-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å %</label>
                 <input type="number" id="config-weight" placeholder="%" class="w-full mt-1 border border-slate-300 rounded-lg px-3 py-2 text-sm text-center outline-none">
               </div>
               <button onclick="addScoreConfig()" class="bg-sky-600 hover:bg-sky-700 text-white px-4 py-2 rounded-lg text-sm font-semibold shadow-md transition-colors h-[38px]">
                 + ‡πÄ‡∏û‡∏¥‡πà‡∏°
               </button>
            </div>
            
            <!-- List of Configs -->
            <div id="config-list-container" class="space-y-2">
              <p class="text-sm text-slate-400 text-center py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>
            </div>
          </div>

          <!-- Student Management -->
          <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
            <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
              <span class="bg-sky-100 text-sky-600 w-8 h-8 rounded-full flex items-center justify-center text-sm">2</span>
              ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </h2>
            
            <div class="flex gap-2 border-b border-slate-200 mb-4">
               <button onclick="showSubTab('single')" class="px-4 py-2 text-sm font-medium border-b-2 border-sky-600 text-sky-700 subtab-btn" id="btn-single">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô</button>
               <button onclick="showSubTab('multi')" class="px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 subtab-btn" id="btn-multi">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
            </div>

            <!-- Single Add -->
            <div id="view-single" class="grid grid-cols-1 md:grid-cols-4 gap-3 mb-6">
              <input type="text" id="add-id" placeholder="‡∏£‡∏´‡∏±‡∏™ (‡πÄ‡∏ä‡πà‡∏ô 6601)" class="border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-sky-500">
              <input type="text" id="add-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" class="md:col-span-2 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-sky-500">
              <div class="flex gap-2">
                <input type="text" id="add-class" placeholder="‡∏´‡πâ‡∏≠‡∏á (‡∏°.1/1)" class="flex-1 border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-sky-500">
                <button onclick="addSingleStudent()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 rounded-lg shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
            </div>

            <!-- Multi Add -->
            <div id="view-multi" class="hidden mb-6">
              <textarea id="add-multi-text" rows="4" class="w-full border border-slate-300 rounded-lg p-3 text-sm font-mono mb-2" placeholder="6601, ‡∏ô‡∏≤‡∏¢ ‡∏Å, ‡∏°.1/1&#10;6602, ‡∏ô‡∏≤‡∏¢ ‡∏Ç, ‡∏°.1/1"></textarea>
              <button onclick="addMultipleStudents()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-2 rounded-lg text-sm shadow-sm">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>

            <!-- Student Table -->
            <div class="table-container max-h-[400px]">
              <table class="w-full text-sm text-left">
                <thead class="text-slate-600 bg-slate-100 border-b border-slate-200 uppercase text-xs">
                  <tr>
                    <th class="px-4 py-3">‡∏£‡∏´‡∏±‡∏™</th>
                    <th class="px-4 py-3">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th class="px-4 py-3">‡∏´‡πâ‡∏≠‡∏á</th>
                    <th class="px-4 py-3 text-center w-20">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                  </tr>
                </thead>
                <tbody id="student-list-body" class="bg-white divide-y divide-slate-100">
                  <tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- ==================== 2. SCORE SECTION ==================== -->
        <section id="score-section" class="hidden animate-fade space-y-4">
          <div class="flex flex-wrap justify-between items-center bg-white p-4 rounded-xl shadow-sm border border-slate-200 gap-3">
             <div class="flex items-center gap-3">
                <span class="text-sm font-semibold text-slate-700">‡∏Å‡∏£‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô:</span>
                <select id="score-class-filter" onchange="renderScoreTable()" class="border border-slate-300 rounded-lg px-3 py-1.5 text-sm outline-none focus:border-sky-500 min-w-[150px]">
                  <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                </select>
             </div>
             <button onclick="exportScores()" class="flex items-center gap-2 bg-emerald-50 text-emerald-600 border border-emerald-200 px-4 py-1.5 rounded-lg text-sm font-medium hover:bg-emerald-100 transition-colors">
               üì• Export CSV
             </button>
          </div>

          <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
             <div class="table-container max-h-[calc(100vh-250px)]">
               <table class="w-full text-sm">
                 <thead class="bg-slate-50 border-b border-slate-200 text-slate-600 uppercase text-xs">
                   <tr id="score-table-head">
                     <!-- Javascript will populate this -->
                   </tr>
                 </thead>
                 <tbody id="score-table-body" class="divide-y divide-slate-100">
                    <!-- Javascript will populate this -->
                 </tbody>
               </table>
             </div>
          </div>
        </section>

        <!-- ==================== 3. ATTENDANCE SECTION ==================== -->
        <section id="attendance-section" class="hidden animate-fade space-y-4">
           <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex flex-wrap gap-4 items-end">
              <div>
                <label class="block text-xs font-semibold text-slate-500 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á</label>
                <select id="att-class-select" onchange="renderAttendance()" class="border border-slate-300 rounded-lg px-3 py-2 text-sm min-w-[150px] outline-none">
                  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-semibold text-slate-500 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input type="date" id="att-date" onchange="renderAttendance()" class="border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none">
              </div>
              <div class="ml-auto">
                <button onclick="saveAttendance()" class="bg-sky-600 hover:bg-sky-700 text-white px-6 py-2 rounded-lg text-sm font-semibold shadow-md">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
              </div>
           </div>

           <div id="att-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-3">
              <!-- Grid Items -->
           </div>
        </section>

      </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-6 right-6 z-50 flex flex-col gap-2 pointer-events-none"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- Firebase Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyBiNUMgq6947gGmgRIzjK-pBgvlwH9sl8o",
      authDomain: "score-34a9b.firebaseapp.com",
      projectId: "score-34a9b",
      storageBucket: "score-34a9b.firebasestorage.app",
      messagingSenderId: "427887505257",
      appId: "1:427887505257:web:be057068b9fe059688d7f8",
      measurementId: "G-ZWJTFQJVNS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION = "school_data_v4"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ Collection ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î

    // --- State ---
    let students = [];
    let configs = [];
    let classes = new Set();

    // --- Helper Functions ---
    window.showToast = (msg, type = 'success') => {
      const box = document.createElement('div');
      box.className = `${type === 'error' ? 'bg-rose-500' : 'bg-emerald-500'} text-white px-4 py-3 rounded-lg shadow-lg text-sm animate-fade flex items-center gap-2 font-medium`;
      box.innerHTML = type === 'error' ? `<span>‚ö†Ô∏è</span> ${msg}` : `<span>‚úÖ</span> ${msg}`;
      document.getElementById('toast-container').appendChild(box);
      setTimeout(() => box.remove(), 3000);
    };

    const setStatus = (status) => {
      const dot = document.getElementById('status-dot');
      const text = document.getElementById('status-text');
      if (status) {
        dot.className = "w-2 h-2 rounded-full bg-emerald-500";
        text.textContent = "Online";
        text.className = "text-emerald-600";
      } else {
        dot.className = "w-2 h-2 rounded-full bg-rose-500";
        text.textContent = "Offline/Error";
        text.className = "text-rose-600";
      }
    };

    // --- Initialization ---
    const init = () => {
      document.getElementById('att-date').valueAsDate = new Date();
      
      const q = query(collection(db, COLLECTION));
      onSnapshot(q, (snap) => {
        setStatus(true);
        const rawStudents = [];
        const rawConfigs = [];
        const rawClasses = new Set();

        snap.forEach(d => {
          const data = d.data();
          data.id = d.id;
          if (data.type === 'student') {
            rawStudents.push(data);
            if(data.class_name) rawClasses.add(data.class_name);
          }
          if (data.type === 'config') rawConfigs.push(data);
        });

        // Sort data
        students = rawStudents.sort((a,b) => a.student_id.localeCompare(b.student_id));
        configs = rawConfigs.sort((a,b) => a.created_at - b.created_at);
        classes = rawClasses;

        // Update UI
        renderStudentList();
        renderConfigList();
        updateClassDropdowns();
        
        // Refresh Current Tab
        if(!document.getElementById('score-section').classList.contains('hidden')) renderScoreTable();
        if(!document.getElementById('attendance-section').classList.contains('hidden')) renderAttendance();

      }, (err) => {
        console.error(err);
        setStatus(false);
      });
    };

    // --- UI Renderers ---
    const renderStudentList = () => {
      const tbody = document.getElementById('student-list-body');
      if (students.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-8 text-center text-slate-400">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
        return;
      }
      tbody.innerHTML = students.map(s => `
        <tr class="hover:bg-slate-50 group transition-colors">
          <td class="px-4 py-3 font-medium text-slate-700">${s.student_id}</td>
          <td class="px-4 py-3">${s.full_name}</td>
          <td class="px-4 py-3"><span class="bg-slate-100 text-slate-600 px-2 py-1 rounded text-xs font-semibold">${s.class_name}</span></td>
          <td class="px-4 py-3 text-center">
            <button onclick="deleteStudent('${s.id}')" class="text-slate-400 hover:text-rose-500 transition-colors p-1 rounded hover:bg-rose-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
            </button>
          </td>
        </tr>
      `).join('');
    };

    const renderConfigList = () => {
      const container = document.getElementById('config-list-container');
      if(configs.length === 0) {
        container.innerHTML = '<div class="text-center p-4 bg-slate-50 border border-dashed border-slate-300 rounded-lg text-slate-400 text-sm">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô)</div>';
        return;
      }
      container.innerHTML = configs.map(c => `
        <div class="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg shadow-sm hover:border-sky-200 transition-colors">
          <div>
            <div class="font-bold text-slate-700">${c.name}</div>
            <div class="text-xs text-slate-500">‡πÄ‡∏ï‡πá‡∏°: ${c.max} | ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: ${c.weight}%</div>
          </div>
          <button onclick="deleteConfig('${c.id}')" class="text-rose-500 hover:text-rose-700 text-sm font-medium px-2 py-1 rounded hover:bg-rose-50">‡∏•‡∏ö</button>
        </div>
      `).join('');
    };

    window.renderScoreTable = () => {
      const thead = document.getElementById('score-table-head');
      const tbody = document.getElementById('score-table-body');
      const filter = document.getElementById('score-class-filter').value;
      const filtered = filter ? students.filter(s => s.class_name === filter) : students;

      // 1. Build Header
      let headers = `
        <th class="px-4 py-3 text-left bg-slate-100 min-w-[80px]">‡∏£‡∏´‡∏±‡∏™</th>
        <th class="px-4 py-3 text-left bg-slate-100 min-w-[150px]">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
      `;
      configs.forEach(c => {
        headers += `<th class="px-2 py-3 text-center bg-sky-50 text-sky-700 min-w-[80px] border-l border-white">${c.name}<br><span class="text-[10px] opacity-70">(${c.max})</span></th>`;
      });
      headers += `<th class="px-4 py-3 text-center bg-slate-100 min-w-[80px] border-l border-white">‡∏£‡∏ß‡∏°</th>
                  <th class="px-4 py-3 text-center bg-slate-100 min-w-[60px]">‡πÄ‡∏Å‡∏£‡∏î</th>`;
      thead.innerHTML = headers;

      // 2. Build Body
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${4 + configs.length}" class="p-8 text-center text-slate-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>`;
        return;
      }

      tbody.innerHTML = filtered.map((s, idx) => {
        const scores = s.scores || {};
        let totalWeight = 0;
        
        const inputs = configs.map(c => {
          const val = scores[c.id] !== undefined ? scores[c.id] : '';
          // Calculate weight for display
          if(val !== '') totalWeight += (parseFloat(val) / c.max) * c.weight;
          
          return `
            <td class="p-1 border-l border-slate-100 text-center">
              <input type="number" 
                value="${val}" 
                min="0" max="${c.max}"
                class="w-full text-center py-1.5 rounded bg-white hover:bg-sky-50 focus:bg-white focus:ring-2 focus:ring-sky-500 outline-none transition-all text-slate-700 font-medium"
                onchange="updateScore('${s.id}', '${c.id}', this.value)"
              >
            </td>
          `;
        }).join('');

        const grade = calculateGrade(totalWeight);
        const rowBg = idx % 2 === 0 ? 'bg-white' : 'bg-slate-50/50';

        return `
          <tr class="${rowBg} hover:bg-sky-50 transition-colors">
            <td class="px-4 py-3 font-medium text-slate-700 text-sm">${s.student_id}</td>
            <td class="px-4 py-3 text-sm">${s.full_name}</td>
            ${inputs}
            <td class="px-4 py-3 text-center font-bold text-sky-600 border-l border-slate-100">${totalWeight.toFixed(1)}</td>
            <td class="px-4 py-3 text-center font-bold text-slate-700">${grade}</td>
          </tr>
        `;
      }).join('');
    };

    window.renderAttendance = () => {
       const grid = document.getElementById('att-grid');
       const cls = document.getElementById('att-class-select').value;
       const date = document.getElementById('att-date').value;

       if(!cls || !date) {
         grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400 border-2 border-dashed border-slate-200 rounded-xl">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>';
         return;
       }

       const list = students.filter(s => s.class_name === cls);
       if(list.length === 0) {
         grid.innerHTML = '<div class="col-span-full text-center py-12 text-slate-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>';
         return;
       }

       grid.innerHTML = list.map(s => {
         const status = (s.attendance || {})[date] || 'present';
         const styles = {
           present: 'bg-emerald-50 border-emerald-200 text-emerald-700',
           absent: 'bg-rose-50 border-rose-200 text-rose-700',
           sick: 'bg-amber-50 border-amber-200 text-amber-700'
         };
         const icons = { present: '‚úÖ ‡∏°‡∏≤', absent: '‚ùå ‡∏Ç‡∏≤‡∏î', sick: 'ü§í ‡∏•‡∏≤' };

         return `
           <div onclick="toggleAtt('${s.id}')" 
                class="cursor-pointer border-2 rounded-xl p-3 select-none transition-all hover:shadow-md active:scale-95 ${styles[status]} border-opacity-60 hover:border-opacity-100">
             <div class="flex justify-between items-start mb-2">
               <span class="font-bold text-lg">${s.student_id}</span>
               <span class="text-xs bg-white bg-opacity-50 px-2 py-0.5 rounded-full backdrop-blur-sm">${icons[status]}</span>
             </div>
             <div class="text-sm truncate opacity-90">${s.full_name}</div>
           </div>
         `;
       }).join('');
    };

    const updateClassDropdowns = () => {
      const opts = ['<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>', ...Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`)].join('');
      document.getElementById('score-class-filter').innerHTML = opts;
      document.getElementById('att-class-select').innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>' + Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`).join('');
    };

    // --- Actions ---
    window.addSingleStudent = async () => {
      const id = document.getElementById('add-id').value.trim();
      const name = document.getElementById('add-name').value.trim();
      const cls = document.getElementById('add-class').value.trim();
      if(!id || !name || !cls) return showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
      
      // Check duplicate
      if(students.some(s => s.student_id === id)) return showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥', 'error');

      try {
        await addDoc(collection(db, COLLECTION), { type: 'student', student_id: id, full_name: name, class_name: cls, scores: {}, attendance: {} });
        document.getElementById('add-id').value = '';
        document.getElementById('add-name').value = '';
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      } catch(e) { showToast(e.message, 'error'); }
    };

    window.addMultipleStudents = async () => {
      const text = document.getElementById('add-multi-text').value;
      if(!text) return;
      const lines = text.split('\n');
      let count = 0;
      for(let line of lines) {
        const [id, name, cls] = line.split(',').map(s=>s.trim());
        if(id && name && cls && !students.some(s=>s.student_id === id)) {
           await addDoc(collection(db, COLLECTION), { type: 'student', student_id: id, full_name: name, class_name: cls, scores: {}, attendance: {} });
           count++;
        }
      }
      showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏Ñ‡∏ô`);
      document.getElementById('add-multi-text').value = '';
    };

    window.addScoreConfig = async () => {
      const name = document.getElementById('config-name').value;
      const max = parseFloat(document.getElementById('config-max').value);
      const weight = parseFloat(document.getElementById('config-weight').value);
      if(!name || !max || !weight) return showToast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', 'error');

      await addDoc(collection(db, COLLECTION), { type: 'config', name, max, weight, created_at: Date.now() });
      document.getElementById('config-name').value = '';
      document.getElementById('config-max').value = '';
      document.getElementById('config-weight').value = '';
      showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
    };

    window.deleteStudent = async (id) => {
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) {
        await deleteDoc(doc(db, COLLECTION, id));
        showToast('‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
      }
    };

    window.deleteConfig = async (id) => {
      if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏ô‡∏µ‡πâ? ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ')) {
        await deleteDoc(doc(db, COLLECTION, id));
        showToast('‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡πâ‡∏ß');
      }
    };

    window.updateScore = async (sid, cid, val) => {
       const student = students.find(s => s.id === sid);
       const scores = student.scores || {};
       scores[cid] = parseFloat(val);
       await updateDoc(doc(db, COLLECTION, sid), { scores });
       // Note: Firestore listener will auto-update UI, but for smoothness in input we rely on local DOM state mostly
       renderScoreTable(); // Recalculate totals
    };

    window.toggleAtt = async (sid) => {
       const date = document.getElementById('att-date').value;
       const student = students.find(s => s.id === sid);
       const att = student.attendance || {};
       const cur = att[date] || 'present';
       const map = { present: 'absent', absent: 'sick', sick: 'present' };
       att[date] = map[cur];
       
       // Optimistic update
       renderAttendance();
       // Save
       await updateDoc(doc(db, COLLECTION, sid), { attendance: att });
    };

    window.saveAttendance = () => showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');

    // --- Utils ---
    const calculateGrade = (score) => {
       if(score >= 80) return 4;
       if(score >= 75) return 3.5;
       if(score >= 70) return 3;
       if(score >= 65) return 2.5;
       if(score >= 60) return 2;
       if(score >= 55) return 1.5;
       if(score >= 50) return 1;
       return 0;
    };

    window.switchTab = (tab) => {
      ['setup', 'score', 'attendance'].forEach(t => {
         const btn = document.getElementById(`tab-${t}`);
         const sec = document.getElementById(`${t}-section`);
         if(t === tab) {
            btn.className = "tab-active px-6 py-2 rounded-lg text-sm font-semibold transition-all shadow-sm";
            sec.classList.remove('hidden');
         } else {
            btn.className = "tab-inactive px-6 py-2 rounded-lg text-sm font-semibold transition-all";
            sec.classList.add('hidden');
         }
      });
      if(tab === 'score') renderScoreTable();
      if(tab === 'attendance') renderAttendance();
    };

    window.showSubTab = (tab) => {
       const s = document.getElementById('view-single');
       const m = document.getElementById('view-multi');
       const bs = document.getElementById('btn-single');
       const bm = document.getElementById('btn-multi');
       
       if(tab === 'single') {
         s.classList.remove('hidden'); m.classList.add('hidden');
         bs.className = "px-4 py-2 text-sm font-medium border-b-2 border-sky-600 text-sky-700";
         bm.className = "px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700";
       } else {
         s.classList.add('hidden'); m.classList.remove('hidden');
         bm.className = "px-4 py-2 text-sm font-medium border-b-2 border-sky-600 text-sky-700";
         bs.className = "px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700";
       }
    };
    
    window.exportScores = () => {
        let csv = "\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠,‡∏´‡πâ‡∏≠‡∏á";
        configs.forEach(c => csv += `,${c.name}`);
        csv += ",‡∏£‡∏ß‡∏°,‡πÄ‡∏Å‡∏£‡∏î\n";
        students.forEach(s => {
           let row = `${s.student_id},${s.full_name},${s.class_name}`;
           let total = 0;
           configs.forEach(c => {
             const val = (s.scores || {})[c.id] || 0;
             total += (val / c.max) * c.weight;
             row += `,${(s.scores || {})[c.id] || 0}`;
           });
           row += `,${total.toFixed(2)},${calculateGrade(total)}`;
           csv += row + "\n";
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "scores.csv";
        link.click();
    };

    init();
  </script>
</body>
</html>
