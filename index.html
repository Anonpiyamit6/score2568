<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-active { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; }
    .tab-inactive { background: #f1f5f9; color: #64748b; }
    .card-shadow { box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15); }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); }
    /* Styles for Tabs in Add Student Section */
    .sub-tab-active { border-bottom: 2px solid #0ea5e9; color: #0284c7; font-weight: bold; }
    .sub-tab-inactive { border-bottom: 2px solid transparent; color: #64748b; }
    .sub-tab-inactive:hover { color: #0ea5e9; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    
    /* Loading Overlay */
    #loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 100; display: flex; justify-content: center; align-items: center; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-sky-50 via-white to-blue-50">

  <!-- Loading Screen -->
  <div id="loading-overlay">
    <div class="text-center">
      <div class="w-12 h-12 border-4 border-sky-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
      <p class="text-sky-600 font-semibold">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
    </div>
  </div>

  <div id="app" class="h-full overflow-auto hidden">
    <!-- Header -->
    <header class="bg-white border-b border-sky-100 sticky top-0 z-40 card-shadow">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <div>
              <p class="text-xs text-sky-600 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
              <h1 class="text-lg md:text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h1>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span id="connection-status" class="text-xs text-emerald-500 font-medium">‚óè Online</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- Main Tabs -->
      <div class="flex flex-wrap gap-2 mb-6">
        <button id="tab-setup" onclick="switchTab('setup')" class="tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2">
          <span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
        <button id="tab-score" onclick="switchTab('score')" class="tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2">
          <span>üìä</span> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        </button>
        <button id="tab-attendance" onclick="switchTab('attendance')" class="tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2">
          <span>‚è∞</span> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
      </div>

      <!-- ==================== SETUP SECTION ==================== -->
      <section id="setup-section" class="animate-fade space-y-6">
        
        <!-- Add Student Management (New Design) -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üë®‚Äçüéì</span>
            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </h2>

          <!-- Sub Tabs -->
          <div class="flex border-b border-gray-200 mb-4">
            <button onclick="switchSubTab('single')" id="subtab-single" class="sub-tab-active py-2 px-4 text-sm transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏Ñ‡∏ô</button>
            <button onclick="switchSubTab('multiple')" id="subtab-multiple" class="sub-tab-inactive py-2 px-4 text-sm transition-colors">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° (‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</button>
            <button onclick="switchSubTab('file')" id="subtab-file" class="sub-tab-inactive py-2 px-4 text-sm transition-colors">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå (Excel/CSV)</button>
          </div>

          <!-- 1. Add Single -->
          <div id="view-single" class="animate-fade">
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="text" id="add-id" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-sky-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô 65001">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="add-name" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-sky-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏î.‡∏ä.‡∏£‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô">
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
                <input type="text" id="add-class" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-sky-500" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.1/1">
              </div>
            </div>
            <button onclick="addSingleStudent()" class="mt-4 btn-primary text-white px-6 py-2 rounded-lg text-sm w-full sm:w-auto">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
          </div>

          <!-- 2. Add Multiple -->
          <div id="view-multiple" class="hidden animate-fade">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ß‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏•‡∏∞ 1 ‡∏Ñ‡∏ô: ‡∏£‡∏´‡∏±‡∏™, ‡∏ä‡∏∑‡πà‡∏≠, ‡∏´‡πâ‡∏≠‡∏á)</label>
            <textarea id="add-multi-text" rows="5" class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:border-sky-500 font-mono text-sm" 
              placeholder="65001, ‡∏ô‡∏≤‡∏¢ ‡∏Å, ‡∏°.1/1&#10;65002, ‡∏ô‡∏≤‡∏¢ ‡∏Ç, ‡∏°.1/1&#10;65003, ‡∏ô‡∏≤‡∏¢ ‡∏Ñ, ‡∏°.1/2"></textarea>
            <button onclick="addMultipleStudents()" class="mt-3 btn-primary text-white px-6 py-2 rounded-lg text-sm">‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
          </div>

          <!-- 3. Import File -->
          <div id="view-file" class="hidden animate-fade">
            <div class="border-2 border-dashed border-gray-300 rounded-xl p-6 text-center">
              <input type="file" id="import-file" accept=".csv,.xlsx,.xls" class="hidden" onchange="document.getElementById('file-name').textContent = this.files[0]?.name">
              <button onclick="document.getElementById('import-file').click()" class="mx-auto bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm transition-colors mb-2">
                üìÇ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå
              </button>
              <p id="file-name" class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå</p>
              <p class="text-xs text-gray-400 mt-2">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö .csv (UTF-8)</p>
            </div>
            <div class="flex gap-2 mt-4">
              <button onclick="importStudentsFromFile()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm">üì§ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
              <button onclick="downloadTemplate()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg text-sm">üì• ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            </div>
          </div>
          
          <!-- Recent Students List -->
          <div class="mt-6 border-t pt-4">
             <h3 class="text-sm font-semibold text-gray-700 mb-2">‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î (‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î <span id="total-students">0</span> ‡∏Ñ‡∏ô)</h3>
             <div class="max-h-60 overflow-y-auto border rounded-lg">
               <table class="w-full text-sm text-left">
                 <thead class="bg-gray-50 text-gray-600 sticky top-0">
                   <tr>
                     <th class="px-4 py-2">‡∏£‡∏´‡∏±‡∏™</th>
                     <th class="px-4 py-2">‡∏ä‡∏∑‡πà‡∏≠</th>
                     <th class="px-4 py-2">‡∏´‡πâ‡∏≠‡∏á</th>
                     <th class="px-4 py-2 w-20">‡∏•‡∏ö</th>
                   </tr>
                 </thead>
                 <tbody id="student-list-preview">
                   <!-- Students Render Here -->
                 </tbody>
               </table>
             </div>
          </div>
        </div>

        <!-- Score Configuration -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4">üéØ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h2>
          <div class="flex gap-2 mb-4">
             <input type="text" id="config-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠ (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏≠‡∏ö‡∏Å‡∏•‡∏≤‡∏á‡∏†‡∏≤‡∏Ñ)" class="border px-3 py-2 rounded-lg text-sm flex-1">
             <input type="number" id="config-max" placeholder="‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏ï‡πá‡∏°" class="border px-3 py-2 rounded-lg text-sm w-24">
             <input type="number" id="config-weight" placeholder="‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å %" class="border px-3 py-2 rounded-lg text-sm w-24">
             <button onclick="addScoreConfig()" class="btn-primary text-white px-4 py-2 rounded-lg text-sm">‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
          </div>
          <div id="score-config-list" class="space-y-2"></div>
        </div>
      </section>

      <!-- ==================== SCORE SECTION ==================== -->
      <section id="score-section" class="hidden animate-fade space-y-6">
        <div class="bg-white rounded-2xl p-4 card-shadow flex flex-wrap gap-3 justify-between items-center">
           <select id="score-filter-class" onchange="renderScoreTable()" class="border px-4 py-2 rounded-lg text-sm">
             <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
           </select>
           <button onclick="exportScores()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
             <span>üì•</span> Export Excel
           </button>
        </div>

        <div class="bg-white rounded-2xl p-6 card-shadow overflow-hidden">
           <table class="w-full min-w-[600px]">
             <thead class="bg-sky-50">
               <tr>
                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏£‡∏´‡∏±‡∏™</th>
                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                 <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏´‡πâ‡∏≠‡∏á</th>
                 <!-- Dynamic Headers -->
                 <th id="score-headers-start" class="hidden"></th> 
                 <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">‡∏£‡∏ß‡∏°</th>
                 <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">‡πÄ‡∏Å‡∏£‡∏î</th>
               </tr>
             </thead>
             <tbody id="score-table-body"></tbody>
           </table>
        </div>
      </section>

      <!-- ==================== ATTENDANCE SECTION ==================== -->
      <section id="attendance-section" class="hidden animate-fade space-y-6">
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <div class="flex flex-wrap gap-4 items-end">
            <div>
               <label class="block text-sm text-gray-600 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</label>
               <select id="att-class-select" onchange="loadAttendanceView()" class="border px-4 py-2 rounded-lg text-sm w-full min-w-[150px]">
                 <option value="">-- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å --</option>
               </select>
            </div>
            <div>
               <label class="block text-sm text-gray-600 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
               <input type="date" id="att-date" onchange="loadAttendanceView()" class="border px-4 py-2 rounded-lg text-sm">
            </div>
            <button onclick="saveAttendance()" class="btn-primary text-white px-6 py-2 rounded-lg text-sm ml-auto">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</button>
          </div>
        </div>

        <div id="attendance-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
          <div class="col-span-full text-center py-10 text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠</div>
        </div>
      </section>

    </main>

    <!-- Toast Notification -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2 pointer-events-none"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiNUMgq6947gGmgRIzjK-pBgvlwH9sl8o",
      authDomain: "score-34a9b.firebaseapp.com",
      projectId: "score-34a9b",
      storageBucket: "score-34a9b.firebasestorage.app",
      messagingSenderId: "427887505257",
      appId: "1:427887505257:web:be057068b9fe059688d7f8",
      measurementId: "G-ZWJTFQJVNS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = "school_data_v2"; // Changed collection to ensure clean start

    // State Variables
    let students = [];
    let configs = [];
    let classes = new Set();
    let attendanceData = {}; // Temp store for UI

    // ==================== APP INITIALIZATION ====================
    async function initApp() {
      // Listener for Realtime Updates
      const q = query(collection(db, COLLECTION_NAME));
      
      onSnapshot(q, (snapshot) => {
        const tempStudents = [];
        const tempConfigs = [];
        const tempClasses = new Set();

        snapshot.forEach((doc) => {
          const data = doc.data();
          data.id = doc.id; // Firestore Document ID
          
          if (data.type === 'student') {
            tempStudents.push(data);
            if(data.class_name) tempClasses.add(data.class_name);
          } else if (data.type === 'config') {
            tempConfigs.push(data);
          }
        });

        // Update State
        students = tempStudents.sort((a,b) => a.student_id.localeCompare(b.student_id));
        configs = tempConfigs.sort((a,b) => a.created_at - b.created_at);
        classes = tempClasses;

        // Update UI
        updateUI();
        
        // Hide Loading
        document.getElementById('loading-overlay').classList.add('hidden');
        document.getElementById('app').classList.remove('hidden');
      }, (error) => {
        console.error("Firebase Error:", error);
        showToast("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", "error");
      });

      // Set Date
      document.getElementById('att-date').valueAsDate = new Date();
    }

    // ==================== UI UPDATES ====================
    function updateUI() {
      // 1. Update Student List Preview
      const tbody = document.getElementById('student-list-preview');
      document.getElementById('total-students').textContent = students.length;
      
      tbody.innerHTML = students.map(s => `
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-2">${s.student_id}</td>
          <td class="px-4 py-2">${s.full_name}</td>
          <td class="px-4 py-2"><span class="bg-gray-100 px-2 py-0.5 rounded text-xs">${s.class_name}</span></td>
          <td class="px-4 py-2">
            <button onclick="window.deleteStudent('${s.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
          </td>
        </tr>
      `).join('');

      // 2. Update Class Dropdowns
      const classOptions = ['<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>', ...Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`)].join('');
      document.getElementById('score-filter-class').innerHTML = classOptions;
      
      const attOptions = ['<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á --</option>', ...Array.from(classes).sort().map(c => `<option value="${c}">${c}</option>`)].join('');
      document.getElementById('att-class-select').innerHTML = attOptions;

      // 3. Update Config List
      document.getElementById('score-config-list').innerHTML = configs.map(c => `
         <div class="flex justify-between items-center bg-gray-50 p-2 rounded border">
           <div><span class="font-bold">${c.name}</span> <span class="text-sm text-gray-500">(Max: ${c.max}, Weight: ${c.weight}%)</span></div>
           <button onclick="window.deleteConfig('${c.id}')" class="text-red-500 text-sm">‡∏•‡∏ö</button>
         </div>
      `).join('');

      // 4. Refresh Active Tab View if needed
      if(!document.getElementById('score-section').classList.contains('hidden')) renderScoreTable();
      if(!document.getElementById('attendance-section').classList.contains('hidden')) window.loadAttendanceView();
    }

    // ==================== ADD STUDENT LOGIC ====================
    window.addSingleStudent = async function() {
      const id = document.getElementById('add-id').value.trim();
      const name = document.getElementById('add-name').value.trim();
      const className = document.getElementById('add-class').value.trim();

      if (!id || !name || !className) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
      if (students.some(s => s.student_id === id)) { showToast('‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ã‡πâ‡∏≥', 'error'); return; }

      try {
        await addDoc(collection(db, COLLECTION_NAME), {
          type: 'student',
          student_id: id,
          full_name: name,
          class_name: className,
          scores: {},
          attendance: {}
        });
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        // Clear inputs
        document.getElementById('add-id').value = '';
        document.getElementById('add-name').value = '';
      } catch (e) {
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'error');
      }
    }

    window.addMultipleStudents = async function() {
      const text = document.getElementById('add-multi-text').value;
      const lines = text.split('\n');
      let count = 0;

      for (let line of lines) {
        const parts = line.split(',').map(s => s.trim());
        if (parts.length >= 3) {
          const [id, name, className] = parts;
          if (id && name && className && !students.some(s => s.student_id === id)) {
            await addDoc(collection(db, COLLECTION_NAME), {
               type: 'student', student_id: id, full_name: name, class_name: className, scores: {}, attendance: {}
            });
            count++;
          }
        }
      }
      showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏Ñ‡∏ô`);
      document.getElementById('add-multi-text').value = '';
    }

    window.importStudentsFromFile = function() {
      const fileInput = document.getElementById('import-file');
      const file = fileInput.files[0];
      if (!file) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô', 'error'); return; }

      const reader = new FileReader();
      reader.onload = async (e) => {
        const text = e.target.result;
        const rows = text.split('\n');
        let count = 0;
        
        // Batch promises to speed up
        const promises = [];

        for (let i = 1; i < rows.length; i++) { // Skip header
           const cols = rows[i].split(',').map(s => s.trim());
           if (cols.length >= 3) {
             const [id, name, className] = cols;
             if (id && name && className && !students.some(s => s.student_id === id)) {
                promises.push(addDoc(collection(db, COLLECTION_NAME), {
                   type: 'student', student_id: id, full_name: name, class_name: className, scores: {}, attendance: {}
                }));
                count++;
             }
           }
        }
        
        await Promise.all(promises);
        showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${count} ‡∏Ñ‡∏ô`);
        fileInput.value = '';
        document.getElementById('file-name').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå';
      };
      reader.readAsText(file); // Ensure UTF-8
    }

    window.downloadTemplate = function() {
      const csvContent = "\uFEFF‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n66001,‡∏î.‡∏ä.‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏£‡∏±‡∏Å‡∏î‡∏µ,‡∏°.1/1";
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "student_template.csv";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    window.deleteStudent = async function(id) {
      if(confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ?')) {
        await deleteDoc(doc(db, COLLECTION_NAME, id));
        showToast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
      }
    }

    // ==================== SCORE LOGIC ====================
    window.addScoreConfig = async function() {
      const name = document.getElementById('config-name').value;
      const max = parseFloat(document.getElementById('config-max').value);
      const weight = parseFloat(document.getElementById('config-weight').value);
      
      if(!name || !max || !weight) return;
      
      await addDoc(collection(db, COLLECTION_NAME), {
        type: 'config', name, max, weight, created_at: Date.now()
      });
      document.getElementById('config-name').value = '';
    }

    window.deleteConfig = async function(id) {
       if(confirm('‡∏•‡∏ö‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏µ‡πâ? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ')) {
         await deleteDoc(doc(db, COLLECTION_NAME, id));
       }
    }

    window.renderScoreTable = function() {
       const tbody = document.getElementById('score-table-body');
       const filterClass = document.getElementById('score-filter-class').value;
       const filteredStudents = filterClass ? students.filter(s => s.class_name === filterClass) : students;
       
       // Headers
       const headerRow = document.querySelector('#score-section thead tr');
       // Remove old dynamic headers
       while(headerRow.children.length > 6) headerRow.removeChild(headerRow.children[3]); 
       
       // Add new headers
       // Note: Simplified for brevity, in real DOM manipulation we'd be more precise
       const baseHeaders = `
         <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏£‡∏´‡∏±‡∏™</th>
         <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
         <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">‡∏´‡πâ‡∏≠‡∏á</th>
       `;
       const configHeaders = configs.map(c => `<th class="px-4 py-3 text-center text-sm font-semibold text-gray-700 bg-sky-100">${c.name}<br><span class="text-xs">(${c.max})</span></th>`).join('');
       const endHeaders = `
         <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">‡∏£‡∏ß‡∏°</th>
         <th class="px-4 py-3 text-center text-sm font-semibold text-gray-700">‡πÄ‡∏Å‡∏£‡∏î</th>
       `;
       headerRow.innerHTML = baseHeaders + configHeaders + endHeaders;

       // Body
       tbody.innerHTML = filteredStudents.map(s => {
         const scores = s.scores || {};
         let total = 0;
         const scoreInputs = configs.map(c => {
           const val = scores[c.id] || 0;
           total += (val / c.max) * c.weight; // Normalize to weight
           return `<td class="p-2 text-center"><input type="number" value="${val}" min="0" max="${c.max}" 
                   class="w-16 border rounded text-center text-sm focus:bg-sky-50"
                   onchange="window.updateScore('${s.id}', '${c.id}', this.value)"></td>`;
         }).join('');
         
         return `
           <tr class="border-b">
             <td class="px-4 py-2">${s.student_id}</td>
             <td class="px-4 py-2">${s.full_name}</td>
             <td class="px-4 py-2 text-gray-500">${s.class_name}</td>
             ${scoreInputs}
             <td class="px-4 py-2 text-center font-bold text-sky-600">${total.toFixed(1)}</td>
             <td class="px-4 py-2 text-center font-bold">${calculateGrade(total)}</td>
           </tr>
         `;
       }).join('');
    }

    window.updateScore = async function(studentId, configId, value) {
       const student = students.find(s => s.id === studentId);
       const scores = student.scores || {};
       scores[configId] = parseFloat(value);
       
       await updateDoc(doc(db, COLLECTION_NAME, studentId), { scores });
       // No need to re-render, listener will do it or local input persists
    }

    function calculateGrade(score) {
      if(score >= 80) return 4;
      if(score >= 75) return 3.5;
      if(score >= 70) return 3;
      if(score >= 65) return 2.5;
      if(score >= 60) return 2;
      if(score >= 55) return 1.5;
      if(score >= 50) return 1;
      return 0;
    }
    
    window.exportScores = function() {
        // Prevent auto-download issues by creating element dynamically on click only
        let csv = "\uFEFF‡∏£‡∏´‡∏±‡∏™,‡∏ä‡∏∑‡πà‡∏≠,‡∏´‡πâ‡∏≠‡∏á";
        configs.forEach(c => csv += `,${c.name}`);
        csv += ",‡∏£‡∏ß‡∏°,‡πÄ‡∏Å‡∏£‡∏î\n";
        
        students.forEach(s => {
           let row = `${s.student_id},${s.full_name},${s.class_name}`;
           let total = 0;
           configs.forEach(c => {
             const val = (s.scores || {})[c.id] || 0;
             total += (val / c.max) * c.weight;
             row += `,${val}`;
           });
           row += `,${total.toFixed(2)},${calculateGrade(total)}`;
           csv += row + "\n";
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = "scores_export.csv";
        document.body.appendChild(link); // Append to body
        link.click();
        document.body.removeChild(link); // Remove immediately
        URL.revokeObjectURL(url);
    }

    // ==================== ATTENDANCE LOGIC ====================
    window.loadAttendanceView = function() {
      const classSelect = document.getElementById('att-class-select').value;
      const date = document.getElementById('att-date').value;
      const grid = document.getElementById('attendance-grid');
      
      if(!classSelect || !date) {
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>';
        return;
      }

      const classStudents = students.filter(s => s.class_name === classSelect);
      if(classStudents.length === 0) {
        grid.innerHTML = '<div class="col-span-full text-center py-10 text-gray-400">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</div>';
        return;
      }

      grid.innerHTML = classStudents.map(s => {
         const status = (s.attendance || {})[date] || 'present';
         let colorClass = 'bg-emerald-100 border-emerald-500';
         let icon = '‚úÖ';
         let label = '‡∏°‡∏≤';

         if(status === 'absent') { colorClass = 'bg-red-100 border-red-500'; icon = '‚ùå'; label = '‡∏Ç‡∏≤‡∏î'; }
         if(status === 'sick') { colorClass = 'bg-yellow-100 border-yellow-500'; icon = 'ü§í'; label = '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢'; }

         return `
           <div onclick="window.toggleAttendance('${s.id}')" id="card-${s.id}" 
                class="cursor-pointer border-2 rounded-xl p-4 transition-all hover:scale-105 ${colorClass}">
              <div class="flex justify-between items-center">
                 <div>
                   <div class="font-bold text-gray-800">${s.student_id}</div>
                   <div class="text-sm">${s.full_name}</div>
                 </div>
                 <div class="text-2xl">${icon}</div>
              </div>
              <div class="text-xs font-bold mt-2 text-gray-600 status-label">${label}</div>
           </div>
         `;
      }).join('');
    }

    window.toggleAttendance = async function(id) {
       // Optimistic UI Update (Visual only first)
       const date = document.getElementById('att-date').value;
       const student = students.find(s => s.id === id);
       if(!student.attendance) student.attendance = {};
       
       const current = student.attendance[date] || 'present';
       const states = ['present', 'absent', 'sick'];
       const next = states[(states.indexOf(current) + 1) % states.length];
       
       student.attendance[date] = next; // Update Local State
       window.loadAttendanceView(); // Re-render Grid
    }

    window.saveAttendance = async function() {
       const date = document.getElementById('att-date').value;
       const classSelect = document.getElementById('att-class-select').value;
       const classStudents = students.filter(s => s.class_name === classSelect);
       
       const promises = classStudents.map(s => {
          return updateDoc(doc(db, COLLECTION_NAME, s.id), {
             attendance: s.attendance
          });
       });

       await Promise.all(promises);
       showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
    }

    // ==================== UTILS ====================
    window.switchTab = function(tabId) {
       ['setup', 'score', 'attendance'].forEach(t => {
          document.getElementById(`tab-${t}`).className = t === tabId ? 
             'tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2' : 
             'tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all flex items-center gap-2';
          document.getElementById(`${t}-section`).className = t === tabId ? 'animate-fade space-y-6' : 'hidden';
       });
       updateUI();
    }

    window.switchSubTab = function(subId) {
       ['single', 'multiple', 'file'].forEach(t => {
          document.getElementById(`subtab-${t}`).className = t === subId ? 'sub-tab-active py-2 px-4 text-sm' : 'sub-tab-inactive py-2 px-4 text-sm';
          document.getElementById(`view-${t}`).className = t === subId ? 'animate-fade' : 'hidden';
       });
    }

    window.showToast = function(msg, type = 'success') {
       const box = document.createElement('div');
       box.className = `${type === 'error' ? 'bg-red-500' : 'bg-emerald-500'} text-white px-4 py-2 rounded shadow-lg text-sm animate-fade`;
       box.textContent = msg;
       document.getElementById('toast-container').appendChild(box);
       setTimeout(() => box.remove(), 3000);
    }

    // Start
    initApp();

  </script>
</body>
</html>
