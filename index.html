<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .tab-active { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; }
    .tab-inactive { background: #f1f5f9; color: #64748b; }
    .card-shadow { box-shadow: 0 4px 20px rgba(14, 165, 233, 0.15); }
    .btn-primary { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); }
    .btn-primary:hover { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); }
    .status-normal { background: #dcfce7; color: #166534; }
    .status-warning { background: #fef9c3; color: #854d0e; }
    .status-danger { background: #fee2e2; color: #991b1b; }
    .grade-excellent { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .grade-good { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); }
    .grade-fair { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .grade-poor { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fade { animation: fadeIn 0.3s ease-out; }
    .input-focus:focus { box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2); }
    .table-row:hover { background: #f0f9ff; }
    .modal-overlay { background: rgba(0, 0, 0, 0.5); }
    .modal-content { background: white; }
    .attendance-card { border: 2px solid #e0e7ff; border-radius: 12px; padding: 12px; cursor: pointer; transition: all 0.2s; }
    .attendance-card.present { background: #dcfce7; border-color: #16a34a; }
    .attendance-card.absent { background: #fee2e2; border-color: #dc2626; }
    .attendance-card.sick { background: #fef08a; border-color: #eab308; }
    .attendance-card.business { background: #dbeafe; border-color: #0284c7; }
    .attendance-card.activity { background: #e9d5ff; border-color: #a855f7; }
    .attendance-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2); }
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold; }
  </style>
</head>
<body class="h-full bg-gradient-to-br from-sky-50 via-white to-blue-50">
  <div id="app" class="h-full overflow-auto">
    <!-- Header -->
    <header class="bg-white border-b border-sky-100 sticky top-0 z-40 card-shadow">
      <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between flex-wrap gap-3">
          <div class="flex items-center gap-3">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-sky-500 to-blue-600 flex items-center justify-center">
              <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
            <div>
              <p id="school-name" class="text-xs text-sky-600 font-medium">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</p>
              <h1 id="system-title" class="text-lg md:text-xl font-bold text-gray-800">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
            </div>
          </div>
          <div class="flex items-center gap-2">
            <span class="hidden sm:inline text-xs text-gray-500">üìÖ</span>
            <span id="current-date" class="text-xs text-gray-600"></span>
            <span id="connection-status" class="ml-2 text-xs text-emerald-500 font-medium animate-pulse">‚óè Online</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-6">
      <!-- Tabs -->
      <div class="flex flex-wrap gap-2 mb-6">
        <button id="tab-setup" onclick="switchTab('setup')" class="tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2">
          <span>‚öôÔ∏è</span> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        </button>
        <button id="tab-score" onclick="switchTab('score')" class="tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2">
          <span>üìä</span> ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
        </button>
        <button id="tab-attendance" onclick="switchTab('attendance')" class="tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2">
          <span>‚è∞</span> ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        </button>
      </div>

      <!-- Setup Section -->
      <section id="setup-section" class="animate-fade space-y-6">
        <!-- Class Management -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üè´</span>
            ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="text-red-500">*</span></label>
              <input type="text" id="class-name-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏°.4/1"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
            </div>
            <div class="flex items-end gap-2">
              <button onclick="addClass()" class="flex-1 btn-primary text-white px-6 py-2.5 rounded-xl font-semibold text-sm transition-all hover:shadow-lg">
                ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
              </button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-3" id="class-list">
            <!-- Classes will be listed here -->
            <p class="col-span-full text-center text-gray-400 py-4">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
          </div>
        </div>

        <!-- Score Config -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üéØ</span>
            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
          </h2>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span class="text-red-500">*</span></label>
              <input type="text" id="score-name-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏Å‡πá‡∏ö"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô <span class="text-red-500">*</span></label>
              <input type="number" id="score-max-input" placeholder="20" min="1"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (%) <span class="text-red-500">*</span></label>
              <input type="number" id="score-weight-input" placeholder="20" min="0" max="100"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
            </div>
          </div>
          <div class="flex gap-2 mb-4">
            <button onclick="addScoreType()" class="btn-primary text-white px-6 py-2.5 rounded-xl font-semibold text-sm transition-all hover:shadow-lg">
              ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            </button>
            <span id="weight-total" class="text-sm font-bold text-gray-700 flex items-center gap-2">
              ‡∏£‡∏ß‡∏°‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å: <span id="weight-sum">0</span>%
            </span>
          </div>
          <div id="score-config-list" class="space-y-2">
            <!-- Score types will be listed here -->
          </div>
        </div>

        <!-- Import Students -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üì•</span>
            ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </h2>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå CSV ‡∏´‡∏£‡∏∑‡∏≠ Excel</label>
            <p class="text-xs text-gray-500 mb-2">‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï: ‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
            <input type="file" id="import-file" accept=".csv,.xlsx,.xls" 
              class="w-full px-4 py-2.5 border border-gray-200 rounded-xl focus:outline-none text-sm">
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
            <button onclick="importStudents()" id="btn-import" class="btn-primary text-white px-6 py-2.5 rounded-xl font-semibold text-sm transition-all hover:shadow-lg">
              üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
            <button onclick="showImportExample()" class="px-6 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-semibold text-sm transition-all">
              üëÄ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå
            </button>
          </div>
        </div>
      </section>

      <!-- Score Section -->
      <section id="score-section" class="hidden animate-fade space-y-6">
        <!-- Filter Bar -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
          <div class="flex flex-wrap gap-3 items-center justify-between">
            <div class="relative flex-1 min-w-[200px] max-w-md">
              <input type="text" id="search-input" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏£‡∏´‡∏±‡∏™‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." 
                class="w-full px-4 py-2.5 pl-10 border border-sky-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm"
                oninput="handleSearch()">
              <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
            </div>
            <select id="class-filter" onchange="handleSearch()" 
              class="px-4 py-2.5 border border-sky-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
              <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
            </select>
            <button onclick="exportToExcel()" class="px-4 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-medium text-sm flex items-center gap-2 transition-colors">
              <span>üì•</span> Export
            </button>
          </div>
        </div>

        <!-- Score Form -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üìù</span>
            <span id="score-form-title">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
          </h2>
          <form id="score-form" onsubmit="handleScoreSubmit(event)">
            <input type="hidden" id="score-edit-id" value="">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="text-red-500">*</span></label>
                <select id="score-class" required onchange="updateStudentList()"
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
                  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                </select>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="text-red-500">*</span></label>
                <select id="score-student" required
                  class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
                  <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                </select>
              </div>
              <div id="score-inputs-container" class="col-span-full">
                <!-- Score inputs will be generated here -->
              </div>
              <div class="col-span-full flex items-end gap-2">
                <button type="submit" id="score-submit-btn" class="flex-1 btn-primary text-white px-6 py-2.5 rounded-xl font-semibold text-sm transition-all hover:shadow-lg">
                  üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                </button>
                <button type="button" onclick="cancelScoreEdit()" id="score-cancel-btn" class="hidden px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-medium text-sm transition-colors">
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              </div>
            </div>
          </form>
        </div>

        <!-- Score Table -->
        <div class="bg-white rounded-2xl p-6 card-shadow overflow-hidden">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üìã</span>
            ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
            <span id="score-count" class="text-sm font-normal text-gray-500">(0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </h2>
          <div class="overflow-x-auto -mx-6 px-6">
            <table class="w-full min-w-[700px]" id="score-table">
              <thead id="score-table-head">
                <tr class="bg-gradient-to-r from-sky-500 to-blue-600 text-white">
                  <th class="px-4 py-3 text-left text-xs font-semibold rounded-tl-xl">‡∏£‡∏´‡∏±‡∏™</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold">‡∏´‡πâ‡∏≠‡∏á</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏£‡∏ß‡∏°</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡πÄ‡∏Å‡∏£‡∏î</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold rounded-tr-xl">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                </tr>
              </thead>
              <tbody id="score-table-body">
                <tr>
                  <td colspan="6" class="px-4 py-12 text-center text-gray-400">
                    <div class="flex flex-col items-center gap-2">
                      <span class="text-4xl">üìä</span>
                      <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Attendance Section -->
      <section id="attendance-section" class="hidden animate-fade space-y-6">
        <!-- Semester Hours and Class Selection -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">‚öôÔ∏è</span>
            ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
          </h2>
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏ó‡∏≠‡∏° <span class="text-red-500">*</span></label>
              <input type="number" id="att-total-hours-input" min="1" max="200" value="40"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm"
                placeholder="‡πÄ‡∏ä‡πà‡∏ô 40" oninput="updateTotalHours()">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="text-red-500">*</span></label>
              <select id="att-class-input" onchange="loadStudentsForClass()"
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm">
                <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô <span class="text-red-500">*</span></label>
              <input type="date" id="att-date-input" 
                class="w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm"
                oninput="handleDateChange()">
            </div>
          </div>
          <div class="bg-sky-50 border border-sky-200 rounded-xl p-3">
            <p class="text-sm text-gray-700"><span class="font-semibold">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î:</span> <span id="display-total-hours" class="text-sky-600 font-bold">40</span> ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</p>
          </div>
        </div>

        <!-- Check-in Table -->
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">‚úÖ</span>
            ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            <span id="attendance-count" class="text-sm font-normal text-gray-500">(0 ‡∏Ñ‡∏ô)</span>
          </h2>
          <div class="mb-3 p-3 bg-blue-50 border border-blue-200 rounded-xl">
            <p class="text-xs text-blue-700 font-medium">üí° ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ‚úÖ ‡∏°‡∏≤ | ‚ùå ‡∏Ç‡∏≤‡∏î | ü§í ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢ | üìã ‡∏•‡∏≤‡∏Å‡∏¥‡∏à | üéØ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          </div>
          <div id="attendance-students-container" class="space-y-2">
            <div class="text-center py-12 text-gray-400">
              <span class="text-4xl block mb-2">üóìÔ∏è</span>
              <span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
            </div>
          </div>
          <div class="flex flex-wrap gap-3 mt-6 pt-4 border-t border-gray-100">
            <button onclick="markAllPresent()" class="flex-1 min-w-[140px] px-4 py-2.5 bg-emerald-500 hover:bg-emerald-600 text-white rounded-xl font-semibold text-sm transition-all">
              ‚úÖ ‡∏°‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="markAllAbsent()" class="flex-1 min-w-[140px] px-4 py-2.5 bg-red-500 hover:bg-red-600 text-white rounded-xl font-semibold text-sm transition-all">
              ‚ùå ‡∏Ç‡∏≤‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button onclick="saveAttendance()" id="btn-save-attendance" class="flex-1 min-w-[140px] px-4 py-2.5 btn-primary text-white rounded-xl font-semibold text-sm transition-all hover:shadow-lg">
              üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            </button>
          </div>
        </div>

        <!-- Attendance Summary Table -->
        <div class="bg-white rounded-2xl p-6 card-shadow overflow-hidden">
          <h2 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
            <span class="w-8 h-8 rounded-lg bg-sky-100 flex items-center justify-center">üìä</span>
            ‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            <span id="summary-count" class="text-sm font-normal text-gray-500">(0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)</span>
          </h2>
          <div class="overflow-x-auto -mx-6 px-6">
            <table class="w-full min-w-[1000px]">
              <thead>
                <tr class="bg-gradient-to-r from-sky-500 to-blue-600 text-white">
                  <th class="px-4 py-3 text-left text-xs font-semibold rounded-tl-xl">‡∏£‡∏´‡∏±‡∏™</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</th>
                  <th class="px-4 py-3 text-left text-xs font-semibold">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏°‡∏≤</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏Ç‡∏≤‡∏î</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏•‡∏≤‡∏Å‡∏¥‡∏à</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                  <th class="px-4 py-3 text-center text-xs font-semibold rounded-tr-xl">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th>
                </tr>
              </thead>
              <tbody id="attendance-summary-body">
                <tr>
                  <td colspan="11" class="px-4 py-12 text-center text-gray-400">
                    <div class="flex flex-col items-center gap-2">
                      <span class="text-4xl">üìã</span>
                      <span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>
    </main>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed bottom-4 right-4 z-50 flex flex-col gap-2"></div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-overlay">
      <div class="modal-content rounded-2xl p-6 max-w-md w-full mx-4 card-shadow animate-fade">
        <h3 id="modal-title" class="text-lg font-bold text-gray-800 mb-4"></h3>
        <div id="modal-content" class="mb-6 text-sm text-gray-700"></div>
        <div class="flex gap-3 justify-end">
          <button onclick="closeModal()" class="px-4 py-2.5 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-xl font-medium transition-colors">
            ‡∏õ‡∏¥‡∏î
          </button>
          <button id="modal-confirm" onclick="confirmModal()" class="px-4 py-2.5 btn-primary text-white rounded-xl font-medium transition-all hover:shadow-lg">
            ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
          </button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ==================== Firebase Config & Init ====================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBiNUMgq6947gGmgRIzjK-pBgvlwH9sl8o",
      authDomain: "score-34a9b.firebaseapp.com",
      projectId: "score-34a9b",
      storageBucket: "score-34a9b.firebasestorage.app",
      messagingSenderId: "427887505257",
      appId: "1:427887505257:web:be057068b9fe059688d7f8",
      measurementId: "G-ZWJTFQJVNS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COLLECTION_NAME = "school_data";

    // Global variables to hold data
    window.allStudentData = []; // Renamed from allData to avoid confusion, but structure is same
    window.allClasses = [];     // Stored in DB with type 'class'
    window.allScoreConfig = []; // Stored in DB with type 'config'
    
    // Attach Firebase functions to window so legacy onclick handlers work
    window.db = db;
    
    // ==================== App State ====================
    let currentTab = 'setup';
    let searchQuery = '';
    let currentAttendanceDate = '';
    let currentAttendanceClass = '';
    let totalSemesterHours = 40;
    let attendanceCheckins = {};

    const ATTENDANCE_TYPES = {
      present: { label: '‡∏°‡∏≤', icon: '‚úÖ', color: 'present' },
      absent: { label: '‡∏Ç‡∏≤‡∏î', icon: '‚ùå', color: 'absent' },
      sick: { label: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', icon: 'ü§í', color: 'sick' },
      business: { label: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à', icon: 'üìã', color: 'business' },
      activity: { label: '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°', icon: 'üéØ', color: 'activity' }
    };

    // ==================== Data Listeners ====================
    function initDataListener() {
      const q = query(collection(db, COLLECTION_NAME));
      onSnapshot(q, (snapshot) => {
        const docs = snapshot.docs.map(d => ({ ...d.data(), __backendId: d.id }));
        
        // Separate data by type
        window.allStudentData = docs.filter(d => d.type === 'student' || d.type === 'score'); // Support legacy 'score' type
        window.allClasses = docs.filter(d => d.type === 'class').map(d => d.name).sort();
        window.allScoreConfig = docs.filter(d => d.type === 'config').sort((a,b) => a.id - b.id);
        
        // Refresh UI
        renderClasses();
        renderScoreConfig();
        renderScoreInputs();
        updateScoreClassFilter();
        updateAttendanceClassFilter();
        
        // Refresh Current View
        if (currentTab === 'score') renderScoreTable();
        if (currentTab === 'attendance') {
           renderAttendanceSummary();
           if (currentAttendanceClass && currentAttendanceDate) {
             loadStudentsForClass(); // Refresh check-in grid if open
           }
        }

        console.log("Data synced:", window.allStudentData.length, "students");
      }, (error) => {
        console.error("Error getting data:", error);
        showToast("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ", "error");
        document.getElementById('connection-status').className = "ml-2 text-xs text-red-500 font-medium";
        document.getElementById('connection-status').textContent = "‚óè Offline";
      });
    }

    // ==================== Shared Functions ====================
    window.showToast = function(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-red-500' : 'bg-sky-500';
      toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-lg animate-fade flex items-center gap-2 text-sm`;
      toast.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100px)';
        toast.style.transition = 'all 0.3s ease';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    window.showModal = function(title, content, onConfirm) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-content').innerHTML = content;
      document.getElementById('modal-confirm').onclick = onConfirm;
      document.getElementById('modal').classList.remove('hidden');
    }

    window.closeModal = function() {
      document.getElementById('modal').classList.add('hidden');
    }

    window.confirmModal = function() {
      // Placeholder, gets overridden
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      const setupSection = document.getElementById('setup-section');
      const scoreSection = document.getElementById('score-section');
      const attendanceSection = document.getElementById('attendance-section');
      const setupTab = document.getElementById('tab-setup');
      const scoreTab = document.getElementById('tab-score');
      const attendanceTab = document.getElementById('tab-attendance');

      [setupSection, scoreSection, attendanceSection].forEach(s => s?.classList.add('hidden'));
      [setupTab, scoreTab, attendanceTab].forEach(t => t.className = 'tab-inactive px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2');

      if (tab === 'setup') {
        setupSection.classList.remove('hidden');
        setupTab.className = 'tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2';
      } else if (tab === 'score') {
        scoreSection.classList.remove('hidden');
        scoreTab.className = 'tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2';
        renderScoreTable();
      } else {
        attendanceSection.classList.remove('hidden');
        attendanceTab.className = 'tab-active px-5 py-2.5 rounded-xl font-semibold text-sm transition-all duration-300 flex items-center gap-2';
        renderAttendanceSummary();
      }
    }

    // ==================== Class Logic ====================
    window.addClass = async function() {
      const input = document.getElementById('class-name-input');
      const className = input.value.trim();
      
      if (!className) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error'); return; }
      if (window.allClasses.includes(className)) { showToast('‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error'); return; }

      try {
        await addDoc(collection(db, COLLECTION_NAME), {
          type: 'class',
          name: className,
          created_at: new Date().toISOString()
        });
        input.value = '';
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
      }
    }

    window.deleteClass = function(className) {
      const btn = event.target;
      if (btn.getAttribute('data-confirm') === 'true') {
        // Find document ID to delete
        // Note: We need the doc ID. Since allClasses is just strings, we look up in snapshot or store logic needs adjustment.
        // Better: Query Firestore to find the doc with this name and type='class'
        const q = query(collection(db, COLLECTION_NAME), where("type", "==", "class"), where("name", "==", className));
        // Use a one-time fetch to delete
        import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(({ getDocs, deleteDoc, doc }) => {
             getDocs(q).then(snapshot => {
                snapshot.forEach(d => {
                    deleteDoc(doc(db, COLLECTION_NAME, d.id));
                });
                showToast('‡∏•‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
             });
        });

        btn.removeAttribute('data-confirm');
      } else {
        btn.disabled = true;
        btn.innerHTML = '‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô?';
        btn.className = 'px-3 py-1 bg-red-500 text-white rounded-lg text-xs font-medium transition-colors';
        btn.setAttribute('data-confirm', 'true');
        setTimeout(() => {
          btn.disabled = false;
          btn.innerHTML = 'üóëÔ∏è ‡∏•‡∏ö';
          btn.className = 'px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-xs font-medium transition-colors';
          btn.removeAttribute('data-confirm');
        }, 2000);
      }
    }

    window.renderClasses = function() {
      const list = document.getElementById('class-list');
      if (window.allClasses.length === 0) {
        list.innerHTML = '<p class="col-span-full text-gray-400 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
        return;
      }
      list.innerHTML = window.allClasses.map(cls => `
        <div class="bg-gradient-to-br from-sky-50 to-blue-50 border border-sky-200 rounded-xl p-4 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="text-2xl">üè´</span>
            <span class="font-semibold text-gray-800">${cls}</span>
          </div>
          <button onclick="deleteClass('${cls}')" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-xs font-medium transition-colors">
            üóëÔ∏è ‡∏•‡∏ö
          </button>
        </div>
      `).join('');
    }

    // ==================== Score Config Logic ====================
    window.addScoreType = async function() {
      const name = document.getElementById('score-name-input').value.trim();
      const max = parseFloat(document.getElementById('score-max-input').value) || 0;
      const weight = parseFloat(document.getElementById('score-weight-input').value) || 0;

      if (!name) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', 'error'); return; }
      if (max <= 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô > 0', 'error'); return; }

      const currentWeight = window.allScoreConfig.reduce((sum, s) => sum + s.weight, 0);
      if (currentWeight + weight > 100) { showToast(`‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô 100% (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${currentWeight}%)`, 'error'); return; }

      try {
        await addDoc(collection(db, COLLECTION_NAME), {
          type: 'config',
          name, max, weight,
          id: Date.now() // Keep ID for mapping inputs
        });
        document.getElementById('score-name-input').value = '';
        document.getElementById('score-max-input').value = '';
        document.getElementById('score-weight-input').value = '';
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
      } catch (e) {
        showToast('Error saving config', 'error');
      }
    }

    window.deleteScoreType = function(id) {
        // Find doc via logic similar to deleteClass (filter in memory first to find backendID, or query)
        // Since we have __backendId in allScoreConfig from listener
        const config = window.allScoreConfig.find(c => c.id === id || c.__backendId === id);
        if(config && config.__backendId) {
             deleteDoc(doc(db, COLLECTION_NAME, config.__backendId))
                .then(() => showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'));
        }
    }

    window.renderScoreConfig = function() {
      const list = document.getElementById('score-config-list');
      const totalWeight = window.allScoreConfig.reduce((sum, s) => sum + s.weight, 0);
      document.getElementById('weight-sum').textContent = totalWeight;

      if (window.allScoreConfig.length === 0) {
        list.innerHTML = '<p class="text-gray-400 text-center py-4">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</p>';
        return;
      }

      list.innerHTML = window.allScoreConfig.map(s => `
        <div class="bg-sky-50 border border-sky-200 rounded-xl p-3 flex items-center justify-between">
          <div class="flex-1">
            <p class="font-semibold text-gray-800">${s.name}</p>
            <p class="text-xs text-gray-600">‡πÄ‡∏ï‡πá‡∏° ${s.max} ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô ‚Ä¢ ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å ${s.weight}%</p>
          </div>
          <button onclick="deleteScoreType(${s.id})" class="px-3 py-1 bg-red-100 hover:bg-red-200 text-red-600 rounded-lg text-xs font-medium transition-colors">
            üóëÔ∏è
          </button>
        </div>
      `).join('');
    }

    window.renderScoreInputs = function() {
      const container = document.getElementById('score-inputs-container');
      if (window.allScoreConfig.length === 0) { container.innerHTML = ''; return; }
      container.innerHTML = `
        <div class="col-span-full grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          ${window.allScoreConfig.map(s => `
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">${s.name} (${s.max})</label>
              <input type="number" data-score-id="${s.id}" min="0" max="${s.max}" step="0.5"
                class="score-input w-full px-4 py-2.5 border border-gray-200 rounded-xl input-focus focus:border-sky-400 focus:outline-none text-sm"
                placeholder="0-${s.max}">
            </div>
          `).join('')}
        </div>
      `;
    }

    // ==================== Import Logic ====================
    window.showImportExample = function() {
      const example = `‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•,‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n65001,‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ,‡∏°.4/1\n65002,‡∏ô‡∏≤‡∏á‡∏™‡∏°‡∏´‡∏ç‡∏¥‡∏á ‡∏¢‡∏¥‡πâ‡∏°‡∏™‡∏ß‡∏¢,‡∏°.4/1`;
      showModal('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤', `<pre class="bg-gray-100 p-3 rounded-lg text-xs overflow-auto">${example}</pre>`, () => {
        closeModal();
        navigator.clipboard.writeText(example).then(() => showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß'));
      });
    }

    window.importStudents = async function() {
      const file = document.getElementById('import-file').files[0];
      if (!file) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå', 'error'); return; }
      const btn = document.getElementById('btn-import');
      btn.disabled = true; btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...';

      const reader = new FileReader();
      reader.onload = async (e) => {
        try {
          const csv = e.target.result;
          const lines = csv.trim().split('\n');
          let imported = 0;
          
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            const cols = lines[i].split(',').map(c => c.trim());
            if (cols.length < 3) continue;

            const [studentId, fullName, className] = cols;
            if (studentId && fullName && className) {
                // Check dupes in memory
                const exists = window.allStudentData.some(d => d.student_id === studentId);
                if (!exists) {
                    await addDoc(collection(db, COLLECTION_NAME), {
                        type: 'student',
                        class_name: className,
                        student_id: studentId,
                        full_name: fullName,
                        score_data: '{}',
                        attendance_data: '{}',
                        created_at: new Date().toISOString()
                    });
                    
                    // Add class if new
                    if (!window.allClasses.includes(className)) {
                        // Check if we already have this class in DB (to avoid dupes during rapid loop)
                         // Note: Ideally we use a batch or transaction, but for simplicity here:
                         // We rely on the listener to update allClasses, but it might be slow.
                         // Simple fix: just add it to DB, duplicates in DB 'class' entries are handled by renderClasses distinct logic if we wanted, 
                         // but here we check memory. To be safe, we query.
                         // For this snippet, let's assume class management is done manually or distinct query.
                         // Simplest: Check if we haven't added it in this session loop yet either.
                         const qClass = query(collection(db, COLLECTION_NAME), where("type", "==", "class"), where("name", "==", className));
                         const snap = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m => m.getDocs(qClass));
                         if(snap.empty) {
                             await addDoc(collection(db, COLLECTION_NAME), { type: 'class', name: className });
                         }
                    }
                    imported++;
                }
            }
          }
          showToast(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${imported} ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`);
          document.getElementById('import-file').value = '';
        } catch (err) {
          console.error(err);
          showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
        } finally {
            btn.disabled = false; btn.innerHTML = 'üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        }
      };
      reader.readAsText(file);
    }

    // ==================== Score Logic ====================
    window.updateScoreClassFilter = function() {
      const select = document.getElementById('score-class');
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
      window.allClasses.forEach(cls => select.innerHTML += `<option value="${cls}">${cls}</option>`);

      const filterSelect = document.getElementById('class-filter');
      const current = filterSelect.value;
      filterSelect.innerHTML = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';
      window.allClasses.forEach(cls => filterSelect.innerHTML += `<option value="${cls}" ${cls===current?'selected':''}>${cls}</option>`);
    }

    window.updateStudentList = function() {
      const className = document.getElementById('score-class').value;
      const select = document.getElementById('score-student');
      select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
      if (!className) return;
      const studentsInClass = window.allStudentData.filter(d => d.class_name === className).sort((a,b) => a.student_id.localeCompare(b.student_id));
      studentsInClass.forEach(student => {
        select.innerHTML += `<option value="${student.__backendId}">${student.student_id} - ${student.full_name}</option>`;
      });
    }

    window.handleScoreSubmit = async function(e) {
      e.preventDefault();
      const studentBackendId = document.getElementById('score-student').value;
      if (!studentBackendId) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'error'); return; }

      const scoreData = {};
      let isValid = true;
      window.allScoreConfig.forEach(s => {
        const input = document.querySelector(`input[data-score-id="${s.id}"]`);
        const value = parseFloat(input.value) || 0;
        if (value > s.max) { showToast(`${s.name} ‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡∏ô‡∏ß‡∏ô`, 'error'); isValid = false; }
        scoreData[s.id] = value;
      });
      if (!isValid) return;

      const btn = document.getElementById('score-submit-btn');
      btn.disabled = true; btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

      try {
        await updateDoc(doc(db, COLLECTION_NAME, studentBackendId), {
            score_data: JSON.stringify(scoreData)
        });
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
        window.cancelScoreEdit();
      } catch(err) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
      } finally {
        btn.disabled = false; btn.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
      }
    }

    window.cancelScoreEdit = function() {
      document.getElementById('score-edit-id').value = '';
      document.getElementById('score-form').reset();
      document.getElementById('score-form-title').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
      document.getElementById('score-submit-btn').innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
    }

    window.handleSearch = function() {
      searchQuery = document.getElementById('search-input').value.toLowerCase().trim();
      renderScoreTable();
    }

    window.renderScoreTable = function() {
      const tbody = document.getElementById('score-table-body');
      const classFilter = document.getElementById('class-filter').value;
      const maxTotal = window.allScoreConfig.reduce((sum, s) => sum + (s.max * s.weight / 100), 0);

      let scores = window.allStudentData.filter(d => d.class_name);
      if (classFilter) scores = scores.filter(d => d.class_name === classFilter);
      if (searchQuery) scores = scores.filter(d => d.student_id.toLowerCase().includes(searchQuery) || d.full_name.toLowerCase().includes(searchQuery));

      document.getElementById('score-count').textContent = `(${scores.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;
      if (scores.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="px-4 py-12 text-center text-gray-400"><div class="flex flex-col items-center gap-2"><span class="text-4xl">üìä</span><span>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></div></td></tr>`;
        return;
      }

      tbody.innerHTML = scores.map((record, index) => {
        let scoreData = {};
        try { scoreData = JSON.parse(record.score_data || '{}'); } catch (e) {}

        let total = 0;
        window.allScoreConfig.forEach(s => {
          const value = parseFloat(scoreData[s.id]) || 0;
          total += value * (s.weight / 100);
        });

        const grade = calculateGrade(total, maxTotal);
        return `
          <tr class="table-row border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-sky-50/30'}">
            <td class="px-4 py-3 text-sm font-medium text-gray-800">${record.student_id}</td>
            <td class="px-4 py-3 text-sm text-gray-700">${record.full_name}</td>
            <td class="px-4 py-3 text-sm text-gray-600">${record.class_name}</td>
            <td class="px-4 py-3 text-sm text-center font-bold text-gray-800">${total.toFixed(1)}</td>
            <td class="px-4 py-3 text-center"><span class="${getGradeClass(grade)} text-white px-3 py-1 rounded-full text-xs font-bold">${grade}</span></td>
            <td class="px-4 py-3 text-center">
              <button onclick="editScoreRecord('${record.__backendId}')" class="px-3 py-1 bg-sky-100 hover:bg-sky-200 text-sky-600 rounded-lg text-xs font-medium transition-colors">‚úèÔ∏è</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function calculateGrade(total, maxTotal) {
      const percentage = maxTotal > 0 ? (total / maxTotal) * 100 : 0;
      if (percentage >= 80) return 4;
      if (percentage >= 75) return 3.5;
      if (percentage >= 70) return 3;
      if (percentage >= 65) return 2.5;
      if (percentage >= 60) return 2;
      if (percentage >= 55) return 1.5;
      if (percentage >= 50) return 1;
      return 0;
    }

    function getGradeClass(grade) {
      if (grade >= 3.5) return 'grade-excellent';
      if (grade >= 2.5) return 'grade-good';
      if (grade >= 1.5) return 'grade-fair';
      return 'grade-poor';
    }

    window.editScoreRecord = function(id) {
      const record = window.allStudentData.find(d => d.__backendId === id);
      if (!record) return;
      document.getElementById('score-class').value = record.class_name;
      updateStudentList();
      document.getElementById('score-student').value = id;
      
      setTimeout(() => {
        let scoreData = {};
        try { scoreData = JSON.parse(record.score_data || '{}'); } catch (e) {}
        window.allScoreConfig.forEach(s => {
            const input = document.querySelector(`input[data-score-id="${s.id}"]`);
            if(input) input.value = scoreData[s.id] || '';
        });
        document.getElementById('score-edit-id').value = id;
        document.getElementById('score-form-title').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
        document.getElementById('score-submit-btn').innerHTML = 'üíæ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï';
        document.getElementById('score-form').scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }

    // ==================== Attendance Logic ====================
    window.updateTotalHours = function() {
        totalSemesterHours = parseFloat(document.getElementById('att-total-hours-input').value) || 40;
        document.getElementById('display-total-hours').textContent = totalSemesterHours;
        renderAttendanceSummary();
    }
    
    window.updateAttendanceClassFilter = function() {
        const select = document.getElementById('att-class-input');
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
        window.allClasses.forEach(cls => select.innerHTML += `<option value="${cls}">${cls}</option>`);
    }

    window.handleDateChange = function() {
        currentAttendanceDate = document.getElementById('att-date-input').value;
        loadStudentsForClass();
    }

    window.loadStudentsForClass = function() {
        currentAttendanceClass = document.getElementById('att-class-input').value;
        if (!currentAttendanceDate || !currentAttendanceClass) {
            document.getElementById('attendance-students-container').innerHTML = `<div class="text-center py-12 text-gray-400"><span class="text-4xl block mb-2">üóìÔ∏è</span><span>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</span></div>`;
            return;
        }

        const students = window.allStudentData.filter(d => d.class_name === currentAttendanceClass).sort((a,b) => a.student_id.localeCompare(b.student_id));
        document.getElementById('attendance-count').textContent = `(${students.length} ‡∏Ñ‡∏ô)`;

        if (students.length === 0) {
            document.getElementById('attendance-students-container').innerHTML = `<div class="text-center py-12 text-gray-400"><span class="text-4xl block mb-2">üë•</span><span>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span></div>`;
            return;
        }

        attendanceCheckins = {};
        students.forEach(s => {
            let attendanceData = {};
            try { attendanceData = JSON.parse(s.attendance_data || '{}'); } catch (e) {}
            attendanceCheckins[s.__backendId] = attendanceData[currentAttendanceDate] || 'present';
        });

        renderStudentsCheckin(students);
    }

    window.renderStudentsCheckin = function(students) {
        document.getElementById('attendance-students-container').innerHTML = students.map(student => {
            const status = attendanceCheckins[student.__backendId] || 'present';
            const typeInfo = ATTENDANCE_TYPES[status];
            return `
              <div class="attendance-card ${typeInfo.color}" onclick="cycleAttendanceStatus('${student.__backendId}')">
                <div class="flex items-center justify-between">
                  <div class="flex-1">
                    <p class="font-semibold text-gray-800">${student.student_id} - ${student.full_name}</p>
                    <p class="text-xs text-gray-600 mt-1">${typeInfo.label}</p>
                  </div>
                  <span class="text-2xl">${typeInfo.icon}</span>
                </div>
              </div>
            `;
        }).join('');
    }

    window.cycleAttendanceStatus = function(backendId) {
        const statuses = ['present', 'absent', 'sick', 'business', 'activity'];
        const current = attendanceCheckins[backendId] || 'present';
        const next = statuses[(statuses.indexOf(current) + 1) % statuses.length];
        attendanceCheckins[backendId] = next;
        
        // Re-render just this card or all (all for simplicity)
        const students = window.allStudentData.filter(d => d.class_name === currentAttendanceClass).sort((a,b) => a.student_id.localeCompare(b.student_id));
        renderStudentsCheckin(students);
    }

    window.markAllPresent = function() {
        Object.keys(attendanceCheckins).forEach(id => attendanceCheckins[id] = 'present');
        const students = window.allStudentData.filter(d => d.class_name === currentAttendanceClass).sort((a,b) => a.student_id.localeCompare(b.student_id));
        renderStudentsCheckin(students);
    }

    window.markAllAbsent = function() {
        Object.keys(attendanceCheckins).forEach(id => attendanceCheckins[id] = 'absent');
        const students = window.allStudentData.filter(d => d.class_name === currentAttendanceClass).sort((a,b) => a.student_id.localeCompare(b.student_id));
        renderStudentsCheckin(students);
    }

    window.saveAttendance = async function() {
        if (!currentAttendanceDate || !currentAttendanceClass) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error'); return; }
        const students = window.allStudentData.filter(d => d.class_name === currentAttendanceClass);
        const btn = document.getElementById('btn-save-attendance');
        btn.disabled = true; btn.innerHTML = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
        
        try {
            // Using Promise.all for better performance than sequential loop
            const promises = students.map(student => {
                let attendanceData = {};
                try { attendanceData = JSON.parse(student.attendance_data || '{}'); } catch(e) {}
                attendanceData[currentAttendanceDate] = attendanceCheckins[student.__backendId] || 'present';
                return updateDoc(doc(db, COLLECTION_NAME, student.__backendId), {
                    attendance_data: JSON.stringify(attendanceData)
                });
            });
            await Promise.all(promises);
            showToast(`‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${students.length} ‡∏Ñ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
            renderAttendanceSummary();
        } catch(err) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
            console.error(err);
        } finally {
            btn.disabled = false; btn.innerHTML = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
        }
    }

    window.renderAttendanceSummary = function() {
        const tbody = document.getElementById('attendance-summary-body');
        const records = window.allStudentData.filter(d => d.class_name);
        if (records.length === 0) {
            tbody.innerHTML = `<tr><td colspan="11" class="px-4 py-12 text-center text-gray-400">...</td></tr>`;
            return;
        }
        document.getElementById('summary-count').textContent = `(${records.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`;

        tbody.innerHTML = records.map((record, index) => {
            let data = {};
            try { data = JSON.parse(record.attendance_data || '{}'); } catch(e) {}
            
            let counts = { present:0, absent:0, sick:0, business:0, activity:0 };
            Object.values(data).forEach(s => counts[s] ? counts[s]++ : counts.present++); // Default to present if unknown, logic adjustment

            const totalDays = Object.keys(data).length;
            const presentScore = counts.present; 
            const percentage = totalDays > 0 ? (presentScore / totalDays * 100) : 0; // Simple calc
            
            let statusClass = 'status-normal'; let statusText = '‡∏õ‡∏Å‡∏ï‡∏¥';
            const allowedAbsences = totalSemesterHours * 0.2;
            if(counts.absent > allowedAbsences) { statusClass = 'status-danger'; statusText = '‡∏°‡∏™.'; }

            return `
            <tr class="table-row border-b border-gray-100 ${index % 2 === 0 ? 'bg-white' : 'bg-sky-50/30'}">
                <td class="px-4 py-3 text-sm font-medium">${record.student_id}</td>
                <td class="px-4 py-3 text-sm">${record.full_name}</td>
                <td class="px-4 py-3 text-sm">${record.class_name}</td>
                <td class="px-4 py-3 text-center text-emerald-600 font-bold">${counts.present}</td>
                <td class="px-4 py-3 text-center text-red-600 font-bold">${counts.absent}</td>
                <td class="px-4 py-3 text-center text-yellow-600 font-bold">${counts.sick}</td>
                <td class="px-4 py-3 text-center text-blue-600 font-bold">${counts.business}</td>
                <td class="px-4 py-3 text-center text-purple-600 font-bold">${counts.activity}</td>
                <td class="px-4 py-3 text-center font-bold">${percentage.toFixed(0)}%</td>
                <td class="px-4 py-3 text-center"><span class="${statusClass} status-badge">${statusText}</span></td>
                <td class="px-4 py-3 text-center">
                    <button onclick="editAttendanceRecord('${record.__backendId}')" class="px-3 py-1 bg-sky-100 text-sky-600 rounded">‚úèÔ∏è</button>
                </td>
            </tr>`;
        }).join('');
    }
    
    window.editAttendanceRecord = function(id) {
        const record = window.allStudentData.find(d => d.__backendId === id);
        if(!record) return;
        let data = {}; try { data = JSON.parse(record.attendance_data || '{}'); } catch(e){}
        
        const content = Object.entries(data).map(([date, status]) => `
            <div class="flex justify-between bg-gray-50 p-3 rounded mb-2">
                <span>${new Date(date).toLocaleDateString('th-TH')} (${ATTENDANCE_TYPES[status]?.label})</span>
                <button onclick="deleteAttendanceDate('${id}','${date}')" class="text-red-500 text-xs">‡∏•‡∏ö</button>
            </div>
        `).join('') || '<p class="text-center text-gray-400">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>';
        
        showModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ô: '+record.full_name, `<div class="max-h-60 overflow-y-auto">${content}</div>`, ()=>closeModal());
    }
    
    window.deleteAttendanceDate = async function(id, date) {
        const record = window.allStudentData.find(d => d.__backendId === id);
        let data = JSON.parse(record.attendance_data || '{}');
        delete data[date];
        await updateDoc(doc(db, COLLECTION_NAME, id), { attendance_data: JSON.stringify(data) });
        closeModal();
        showToast('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ==================== Export ====================
    window.exportToExcel = function() {
        let csv = '\uFEFF‡∏£‡∏´‡∏±‡∏™‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô,‡∏ä‡∏∑‡πà‡∏≠,‡∏´‡πâ‡∏≠‡∏á';
        window.allScoreConfig.forEach(s => csv += ',' + s.name);
        csv += ',‡∏£‡∏ß‡∏°,‡πÄ‡∏Å‡∏£‡∏î\n';
        
        window.allStudentData.forEach(d => {
            if(!d.class_name) return;
            let score = {}; try { score = JSON.parse(d.score_data||'{}'); } catch(e){}
            let total = 0;
            let line = `${d.student_id},${d.full_name},${d.class_name}`;
            window.allScoreConfig.forEach(s => {
                const val = parseFloat(score[s.id]) || 0;
                total += val * (s.weight/100);
                line += ',' + val;
            });
            line += `,${total.toFixed(2)},${calculateGrade(total, 100)}`; // Assume max 100 for export simplicity or calc properly
            csv += line + '\n';
        });
        
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `scores_${new Date().toISOString().split('T')[0]}.csv`;
        link.click();
    }

    // ==================== Startup ====================
    (function init() {
        const today = new Date();
        document.getElementById('current-date').textContent = today.toLocaleDateString('th-TH', { dateStyle: 'long' });
        document.getElementById('att-date-input').value = today.toISOString().split('T')[0];
        initDataListener();
    })();

  </script>
</body>
</html>
